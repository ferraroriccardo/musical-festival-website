{% extends "base.html" %}

{% block content %}

{% with messages = get_flashed_messages() %}
{% if messages %}
<div id="flash-messages" style="position: fixed; top: 1rem; right: 1rem; z-index: 1050;">
    {% for message in messages %}
    <div class="alert alert-info alert-dismissible fade show" role="alert" style="min-width: 250px;">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}


<div class="d-flex justify-content-center align-items-center banner-blue full-height">
    <section class="card col-8 shadow rounded-4 p-5 transparent-white-bg">
        <!-- return beforeSubmit(event) sostituisce onclick="setPublished(false)" perchÃ© la il sumbit
        era troppo veloce, quindi non si faceva in tempo a modificare la variable published  -->
        <form action="/create_event" method="POST" id="eventForm" onsubmit="return beforeSubmit(event)">
            <h1 class="mb-4 text-center">CREATE EVENT</h1>
            {% if p_drafts and p_drafts|length > 0 %}
            <div class="mb-4">
                <label for="draft_selector" class="form-label">Riprendi da una bozza</label>
                <select class="form-select" id="draft_selector" name="draft_id">
                    <option value="">-- Seleziona una bozza artista --</option>
                    {% for draft in p_drafts %}
                    <option value="{{ draft['id'] }}">{{ draft['artist'] }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            <div class="row mb-3">
                <div class="col-6">
                    <input type="hidden" name="published" id="published" value="">
                    <label for="day" class="form-label">Day</label>
                    <select class="form-select" id="day" name="day" required>
                        <option value="">Select day</option>
                        <option value="friday 20th">Friday 20th</option>
                        <option value="saturday 21st">Saturday 21st</option>
                        <option value="sunday 22nd">Sunday 22nd</option>
                    </select>
                </div>
                <div class="col-6">
                    <label for="start_hour" class="form-label">Start hour</label>
                    <input type="time" class="form-control" id="start_hour" name="start_hour" min="10:00" max="23:59"
                        required>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-6">
                    <label for="duration" class="form-label">Durata (minuti)</label>
                    <input type="number" class="form-control" id="duration" name="duration" min="1" required>
                </div>
                <div class="col-6">
                    <label for="artist" class="form-label">Artist</label>
                    <input type="text" class="form-control" id="artist" name="artist" required>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-6 d-flex flex-column h-100">
                    <label for="description" class="form-label">Description</label>
                    <textarea class="form-control h-100" id="description" name="description" rows="5"
                        required></textarea>
                </div>
                <div class="col-6 d-flex flex-column justify-content-between h-100">
                    <div class="mb-3">
                        <label for="genre" class="form-label">Genre</label>
                        <input type="text" class="form-control" id="genre" name="genre" required>
                    </div>
                    <label for="stage" class="form-label">Stage</label>
                    <select class="form-select" id="stage" name="stage" required>
                        <option value="">Select stage</option>
                        {% for s in p_stages %}
                        <option value="{{ s.nome }}">{{ s.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="mb-3">
                <label for="image" class="form-label">Upload image</label>
                <input class="form-control" type="file" id="image" name="image" accept="image/*" required>
            </div>
            <div class="d-flex justify-content-evenly align-items-center mt-4 gap-4">
                <button type="submit" name="action" value="draft"
                    class="btn btn-secondary w-50 rounded-pill max-width">Save as draft</button>
                <button type="submit" name="action" value="publish"
                    class="btn btn-custom-gradient border-gradient shadow btn-lg rounded-pill fw-bold">Publish
                    event</button>
            </div>
        </form>
    </section>
</div>

<script>
    function beforeSubmit(e) {
        const form = document.getElementById('eventForm');

        // Trova quale bottone ha innescato il submit
        const submitter = e.submitter;
        if (!submitter) {
            alert('Errore interno: impossibile determinare l\'azione.');
            e.preventDefault();
            return false;
        }

        // Imposta published in base al bottone premuto
        const isPublish = submitter.value === 'publish';
        document.getElementById('published').value = isPublish ? 1 : 0;

        return true;
    }
</script>
{% endblock %}